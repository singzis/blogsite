---
title: "useEffect ä½¿ç”¨æ€»ç»“"
text: "props æˆ–è€… state çš„æ›´æ–°ä¼šè§¦å‘ç»„ä»¶çš„é‡æ–°æ¸²æŸ“ï¼Œæ¯æ¬¡æ¸²æŸ“éƒ½ä¼šæœ‰å®ƒè‡ªå·±çš„ effctï¼Œä¸” effect ä¼šæ•è·ä¸“å±äºå®ƒè‡ªå·±çš„æ•°æ®æµ props å’Œ stateï¼Œè€Œä¸”æ¯ä¸ª effect ä¸­çš„æ•°æ®éƒ½ä¸åŒäºä»¥å¾€..."
category: "react"
date: "2020-03-19"
---

ğŸ§ğŸ§ğŸ§ åˆ—ä¸€äº›åœ¨ä½¿ç”¨ useEffect çš„æ—¶å€™ï¼Œç»å¸¸ä¼šé‡è§çš„ä¸€äº›é—®é¢˜ï¼Œä»¥åŠä¸€äº›ä½¿ç”¨æ€»ç»“ã€‚

## â˜• useEffect ä¸­çš„ props å’Œ state

props æˆ–è€… state çš„æ›´æ–°ä¼šè§¦å‘ç»„ä»¶çš„é‡æ–°æ¸²æŸ“ï¼Œæ¯æ¬¡æ¸²æŸ“éƒ½ä¼šæœ‰å®ƒè‡ªå·±çš„ effctï¼Œä¸” effect ä¼šæ•è·ä¸“å±äºå®ƒè‡ªå·±çš„æ•°æ®æµ props å’Œ stateï¼Œè€Œä¸”æ¯ä¸ª effect ä¸­çš„æ•°æ®éƒ½ä¸åŒäºä»¥å¾€ï¼Œï¼ˆè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæœ‰æ—¶å€™ effect ä¸­çš„ props å’Œ state ä¼šæ˜¯æ—§å€¼çš„åŸå› ï¼Œç»„ä»¶æ›´æ–°æ²¡èƒ½ä½¿ effect é‡æ–°åˆ›å»ºå»æ•è·æ–°çš„ props å’Œ stateï¼Œå¯¼è‡´å­˜åœ¨å…¶ä¸­çš„ props å’Œ state è¿˜æ˜¯ä¹‹å‰çš„å€¼ï¼Œè¿™æ˜¯é—æ¼äº†ä¸€äº›ä¾èµ–å¯¼è‡´çš„ï¼‰ã€‚

```js
function App() {
  const [count, setCount] = useState(0);

  useEffect(() => {
    setTimeout(() => {
      console.log(count);
    }, 3000);
  }, [count]);

  return <button onClick={() => setCount(count + 1)}>+</button>;
}
```

count çš„å˜åŒ–ä¼šå¯¼è‡´ç»„ä»¶çš„æ›´æ–°ï¼Œé‡æ–°æ¸²æŸ“åçš„ç»„ä»¶ä¼šæ‰§è¡Œ effectã€‚

```js
// åˆæ¬¡æ¸²æŸ“æ—¶,countå–çš„æ˜¯é»˜è®¤å€¼0ï¼Œåœ¨æ­¤æ—¶ï¼Œeffectæ•è·åˆ°å±äºä»–çš„count:0
// ...
useEffect(() => {
  setTimeout(() => {
    console.log(0); // æ­¤åˆ»çš„countä¸º0
  }, 3000);
}, [count]);
// ...

// åœ¨ç‚¹å‡»æŒ‰é’®å¢åŠ countå,countå˜åŒ–å¯¼è‡´ç»„ä»¶é‡æ–°æ¸²æŸ“ï¼Œç”Ÿæˆæ–°çš„effectå¹¶åœ¨æ¸²æŸ“å®Œæˆåè¿è¡Œï¼Œåœ¨æ­¤æ—¶ï¼Œeffectæ•è·åˆ°å±äºä»–çš„count:1

// ...
useEffect(() => {
  setTimeout(() => {
    console.log(1); // æ­¤åˆ»çš„countä¸º1
  }, 3000);
}, [count]);
// ...

// ...
```

> ç»„ä»¶å†…çš„æ¯ä¸€ä¸ªå‡½æ•°ï¼ˆåŒ…æ‹¬äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œeffectsï¼Œå®šæ—¶å™¨æˆ–è€… API è°ƒç”¨ç­‰ç­‰ï¼‰ä¼šæ•è·å®šä¹‰å®ƒä»¬çš„é‚£æ¬¡æ¸²æŸ“ä¸­çš„ props å’Œ stateã€‚

---

## â˜• useEffect çš„ä¾èµ–

é€šè¿‡ä¼ å…¥ä¾èµ–ï¼Œæ¥å‘Šè¯‰ reactï¼Œåªæœ‰å½“ä¼ å…¥çš„ä¾èµ–ä¸­æŸä¸ª state æ”¹å˜æ—¶ï¼Œæ‰è°ƒç”¨ effectã€‚

å¦‚æœå½“å‰æ¸²æŸ“ä¸­è¿™äº›ä¾èµ–é¡¹ï¼Œå’Œä¸Šä¸€æ¬¡è¿è¡Œè¿™ä¸ª effect çš„å€¼ä¸€æ ·ï¼Œå› ä¸ºæ²¡æœ‰ä»€ä¹ˆéœ€è¦åŒæ­¥ï¼Œreact ä¾¿ä¼šè·³è¿‡è¿™æ¬¡ effectã€‚
å¦‚æœè¿™äº›ä¾èµ–ä¸­æœ‰ä¸€ä¸ªå€¼åœ¨ä¸¤æ¬¡æ¸²æŸ“ä¸­ä¸ä¸€æ ·ï¼Œä¾¿ä¸èƒ½è·³è¿‡è¿™æ¬¡ effectï¼Œéœ€è¦åŒæ­¥æ‰€æœ‰ã€‚

å¯¹äº effect æ¥è¯´ï¼Œç”¨åˆ°çš„æ‰€æœ‰ç»„ä»¶å†…çš„å€¼ï¼Œéƒ½å¿…é¡»åŒ…å«åœ¨ä¾èµ–ä¸­ï¼ŒåŒ…æ‹¬ props å’Œ state ä»¥åŠå‡½æ•°ç­‰ä¸€åˆ‡ç»„ä»¶é‡Œçš„ä¸œè¥¿ï¼Œå¯ä»¥é€šè¿‡ä¼ å…¥[]ç©ºæ•°ç»„ï¼Œä½¿ effect åªåœ¨ç»„ä»¶æŒ‚è½½æ—¶æ‰§è¡Œï¼Œå› ä¸ºæ²¡æœ‰ä¾èµ–é¡¹ï¼Œåç»­ä¾¿ä¸ä¼šå†è¢« react è°ƒç”¨ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœåœ¨ effect ä¸­æœ‰ä½¿ç”¨æŸä¸ª effect å¤–çš„æŸä¸ªå‡½æ•°ï¼Œè€Œè¿™ä¸ªå‡½æ•°æœ‰ä½¿ç”¨åˆ°æ•°æ®æµä¸­çš„æŸä¸ª state æˆ–è€… propsï¼Œæ¯”å¦‚ï¼š

```js
function App() {
  const [count, setCount] = useState(0);

  const add = () => `react.${count}`;

  useEffect(() => {
    const v = add();
    // do something need v
  }, []);
  return <button onClick={() => setCount(count + 1)}>+</button>;
}
```

å¸Œæœ›å½“ count æ”¹å˜æ—¶ï¼Œè°ƒç”¨ä¸€æ¬¡ add å‡½æ•°ï¼Œä½†æ˜¯å› ä¸º effect æ²¡æœ‰æŠŠ add å‡½æ•°å½’å…¥ä¾èµ–ï¼Œeffect ä¾¿ä¸ä¼šæ¥æ”¶åˆ° count çš„æ›´æ–°ï¼Œä»¥è‡³äºæ²¡èƒ½åŠæ—¶è°ƒç”¨ addã€‚

è§£å†³åŠæ³•ï¼š

1.æŠŠ add å‡½æ•°æ”¾å…¥ effect ä¸­ï¼Œå¹¶æŠŠå‡½æ•°ç”¨çš„ç»„ä»¶å†…æ•°æ®å½’å…¥ä¾èµ–ï¼ˆè¿™é‡Œæ˜¯ countï¼‰ï¼š

```js
useEffect(() => {
  const add = () => `react.${count}`;
  const v = add();
  // do something need v
}, [count]);
```

2.å¦‚æœæƒ³å¤ç”¨ add å‡½æ•°çš„é€»è¾‘ï¼Œå¯ä»¥æŠŠ add å‡½æ•°ä½œä¸ºä¾èµ–ï¼š

```js
const add = () => `react.${count}`;
useEffect(() => {
  const v = add();
  // do something need v
}, [add]);
```

3.æ–¹æ³• 2 ä¸­çš„ä¾èµ–æ–¹å¼è¿‡äºç®€å•ç²—æš´ï¼Œå› ä¸ºæ¯æ¬¡æ¸²æŸ“éƒ½ä¼šæ›´æ–° add å‡½æ•°ï¼Œä¾¿ä¼šè§¦å‘ effect çš„è°ƒç”¨ã€‚å¯ä»¥é€šè¿‡ä½¿ç”¨ useCallback æ¥åŒ…è£¹å‡½æ•°ï¼Œå¹¶å¯¹å‡½æ•°åŠ ä¸Šä¾èµ–ï¼Œåªæœ‰åœ¨ä¾èµ–æ›´æ–°æ—¶ï¼Œæ‰æ›´æ–°è¿™ä¸ªå‡½æ•°ï¼š

```js
const add = useCallback(() => `react.${count}`, [count]);
useEffect(() => {
  const v = add();
  // do something need v
}, [add]); // è¿™æ ·åœ¨ç»„ä»¶æ¸²æŸ“æ—¶ï¼Œä¾¿ä¸ä¼šæ—¶åˆ»éƒ½æ›´æ–°addå‡½æ•°ï¼Œä»…ä»…åœ¨countå˜åŒ–æ—¶æ‰ä¼šæ›´æ–°addå‡½æ•°
```

---

## â˜• useEffect çš„æ¸…é™¤

ç›®çš„æ˜¯ä¸ºäº†æ¶ˆé™¤ effect çš„å‰¯ä½œç”¨ï¼Œæ¯”å¦‚å–æ¶ˆè®¢é˜…ã€‚

æ¸…é™¤å’Œ effect çš„æ‰§è¡Œä¸€æ ·ï¼Œå‘ç”Ÿåœ¨æ¸²æŸ“ä¹‹åï¼Œä¹Ÿå°±æ˜¯ç•Œé¢ä¸Šå‡ºç°æ–°çš„ UI åï¼Œæ‰ä¼šæ‰§è¡Œæ—§ effect çš„æ¸…é™¤æ“ä½œï¼Œç„¶åæ‰æ˜¯æ–° effect çš„æ‰§è¡Œæ“ä½œï¼Œå¹¶ä¸”ä¸ç”¨æ‹…å¿ƒæ—§ effect ä¸­ props å’Œ state å€¼çš„é—®é¢˜ï¼Œå› ä¸ºä»–åœ¨åˆ›å»ºæ—¶ä¾¿å·²ç»æ•è·äº†éœ€è¦çš„æ•°æ®ã€‚

```js
useEffect(() => {
  ChatAPI.subscribeToFriendStatus(props.id, handleStatusChange);
  return () => {
    ChatAPI.unsubscribeFromFriendStatus(props.id, handleStatusChange);
  };
});
```

æ‰§è¡Œæµç¨‹å¤§æ¦‚æ˜¯ï¼š

- `{id: 10}`çš„æ•°æ®å‘ç”Ÿå˜åŒ–ä¸º`{id: 20}`
- React æ¸²æŸ“`{id: 20}`çš„ UI
- æµè§ˆå™¨ç»˜åˆ¶`{id: 20}`çš„ç•Œé¢
- React æ¸…é™¤`{id: 10}`çš„ effect
- React æ‰§è¡Œ`{id: 20}`çš„ effect

ä¸ç”¨æ‹…å¿ƒ effect ä¼šè®°é”™å®ƒé‡Œé¢çš„å€¼ï¼Œåªè¦ä»–åˆ›å»ºåï¼Œä¾¿ä¸€å®šä¼šæ•è·åˆ°å®ƒä½¿ç”¨åˆ°çš„ç»„ä»¶å†…çš„æ•°æ®æµã€‚

---

## â˜• useEffect ä¸­çš„æ•°æ®è¯·æ±‚

- ä»…åœ¨ç»„ä»¶åˆæ¬¡æ¸²æŸ“åè¿›è¡Œæ•°æ®è¯·æ±‚ï¼š
  - é€šè¿‡ä¼ å…¥ç©ºæ•°ç»„[]ä½œä¸º effect çš„ä¾èµ–ï¼Œé¿å…åœ¨ç»„ä»¶æ›´æ–°æ—¶æ‰§è¡Œï¼Œä»…ä»…åªåœ¨ç»„ä»¶æŒ‚è½½æ—¶æ‰§è¡Œã€‚åœ¨è¿™é‡Œï¼Œä¸åº”è¯¥æŠŠ Promise æˆ–è€… async å‡½æ•°ä½œä¸º effect çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå› ä¸ºä»–ä»¬ä¼šè¿”å›ä¸€ä¸ª Promise ç»“æ„çš„å‡½æ•°ï¼Œæ ¹æ®è¦æ±‚ï¼Œeffect è¦ä¹ˆä»€ä¹ˆéƒ½ä¸è¿”å›ï¼Œè¦ä¹ˆå°±è¿”å›æ¸…é™¤å‡½æ•°ï¼Œæ‰€ä»¥è¿™é‡Œåº”è¯¥å¯¹è¿™ç§æƒ…å†µè¿›è¡ŒåŒ…è£¹å¤„ç†ï¼Œæ¯”å¦‚æŠŠä»–ä»¬åŒ…åœ¨å…¶ä»–å‡½æ•°é‡Œè¿›è¡Œæ“ä½œ
- æ‰‹åŠ¨è¯·æ±‚ï¼š
  - é€šè¿‡ä¼ å…¥éœ€è¦çš„ä¾èµ–ï¼Œæ¯”å¦‚é€šè¿‡è¾“å…¥æ¡†æœç´¢åšè¯·æ±‚ï¼Œä¾¿å¯ä»¥æŠŠè¾“å…¥æ¡†çš„å€¼ä½œä¸ºä¾èµ–ï¼Œå½“å€¼æ”¹å˜æ—¶ä¾¿è¿›è¡Œæœç´¢è¯·æ±‚ï¼Œä¹Ÿè¯·è®°å¾—åšé˜²æŠ–å¤„ç†

æ•°æ®è¯·æ±‚ä¸»è¦æ˜¯éœ€è¦æ‰¾å‡†ä¾èµ–ï¼Œä¸è®¾ç½®ä¾èµ–ï¼Œä¼šå¯¼è‡´ç»„ä»¶æ¯æ¬¡æ¸²æŸ“éƒ½ä¼šå‘é€ä¸€æ¬¡è¯·æ±‚ï¼Œè€Œç›´æ¥æŠŠä¾èµ–è®¾ç½®ä¸º[]ï¼Œè™½ç„¶åªä¼šåœ¨ç»„ä»¶åˆæ¬¡æ¸²æŸ“åæ‰§è¡Œä¸€æ¬¡ï¼Œå…¶åä¾¿ä¸å†è°ƒç”¨ï¼Œä½†éœ€è¦å°å¿ƒè¿™ç§æƒ…å†µï¼Œéœ€è¦å‡†ç¡®æ’æŸ¥æ˜¯å¦æœ‰ç”¨åˆ°ç»„ä»¶å†…æ•°æ®æˆ–è€…å‡½æ•°ï¼Œæœ€å¥½çš„æ–¹å¼è¿˜æ˜¯æ‰¾å‡† effect éœ€è¦çš„ä¾èµ–ï¼Œé˜²æ­¢å‘ç”ŸæœªçŸ¥çš„é”™è¯¯ã€‚

---

## â˜• useEffect ä¸­çš„å›è°ƒå‡½æ•°

æœ€å¸¸è§çš„æƒ…å†µï¼Œå°±æ˜¯åœ¨ effect ä¸­çš„æŸä¸ªå›è°ƒå‡½æ•°é‡Œï¼Œä½¿ç”¨å½“å‰çš„ props æˆ–è€… stateï¼Œè€Œä¸æ˜¯ä¹‹å‰æ•è·çš„æ•°æ®ï¼Œè¿™ç§æƒ…å†µå°±å¥½æ¯”åœ¨è¿‡å»ä½¿ç”¨ç°åœ¨çš„ä¸œè¥¿ã€‚

```js
const [count, setCount] = useState;

useEffect(() => {
  const data = request("www.website.com/api=api", {
    success() {
      // è¯·æ±‚æˆåŠŸåæ‰§è¡Œ,å¹¶æ‰“å°æœ€æ–°çš„count
      console.log(count);
    },
  });
}, []);
```

è¿™ç§æƒ…å†µåœ¨ class ç»„ä»¶é‡Œå±¡è§ä¸é²œï¼Œåœ¨ componentDidMount ä¸­åšå®Œæ•°æ®è¯·æ±‚åï¼Œéœ€è¦ç”¨åˆ°æŸäº›å€¼ï¼Œæˆ‘ä»¬åªéœ€è¦é€šè¿‡ this ä¾¿å¯è½»æ˜“æ‹¿å–åˆ°ã€‚æˆ–è€…æ¯”è¾ƒå¸¸ç”¨çš„å°±æ˜¯åœ¨ componentDidMount è®¾ç½® swiper ç»„ä»¶ï¼Œå› ä¸ºæ¸²æŸ“çš„åŸå› ï¼ŒDOM ä¼šå»¶è¿Ÿç”Ÿæˆï¼Œä½†éœ€è¦åœ¨ç»„ä»¶ä¸­ä½¿ç”¨åˆ°è¿™ä¸ª swiper DOMã€‚

åœ¨ effect ä¸­ï¼Œéœ€è¦è¾¾åˆ°è¿™æ ·çš„æ ‡å‡†ï¼Œå°±å¾—å¯¹æ•°æ®è¿›è¡Œ useRef å¤„ç†ï¼š

```js
const [count, setCount] = useState;
const latestCount = useRef(count);

useEffect(() => {
  latestCount.current = count;
}, [count]);

useEffect(() => {
  const data = request("www.website.com/api=api", {
    success() {
      // è¯·æ±‚æˆåŠŸåæ‰§è¡Œ,å¹¶æ‰“å°æœ€æ–°çš„count
      console.log(latestCount.current);
    },
  });
}, []);
```

swiper ç±»ä¼¼çš„å†™æ³•ï¼ˆè·å– DOMï¼Œå®˜æ–¹æ–‡æ¡£æœ‰ä»‹ç»å¦‚ä½•è®¿é—® DOMï¼‰ï¼š

```js
const [someNode, setSomeNode] = useState;
const swiperNode = useRef(someNode);

useEffect(() => {
  const mySwiper = new Swiper(".swiper-container", {
    // ...
    on: {
      slideChangeTransitionStart: () => {
        console.log(swiperNode.current);
      },
    },
  });
}, []);

return (
  <>
    <div className="swiper-container">...</div>
    <div ref={swiperNode}>some node</div>
  </>
);
```

useRef åŒ…è£¹çš„æ•°æ®ï¼Œå°±æœ‰ç‚¹åƒ class ä¸­ this.state ä¸€æ ·ï¼Œæ¯æ¬¡å¯¹æ•°æ®çš„ä¿®æ”¹ï¼Œéƒ½æ˜¯ä¿®æ”¹çš„ state ä¸­çš„ä¸œè¥¿ï¼Œä¸åƒæ•è·åˆ°çš„ props å’Œ stateï¼Œä½ æ²¡æ³•ä¿è¯åœ¨ä»»æ„ä¸€ä¸ªå›è°ƒå‡½æ•°ä¸­ latestCount.current çš„å€¼æ˜¯ä¸å˜çš„ï¼Œè€Œä¸”æ ¹æ®å®šä¹‰ï¼Œå¯ä»¥éšæ—¶ä¿®æ”¹å®ƒã€‚

è¿™é‡Œä¹Ÿå†æ¬¡è¯ é‡Šäº† useState ä¸­ä¸€ä¸ªè¦ç‚¹ï¼Œå°±æ˜¯ setCount çš„ä½œç”¨æ˜¯æ›¿æ¢åŸå…ˆçš„å€¼ï¼Œä¸ç®¡ä½ æ˜¯å•ç‹¬çš„ä¸€ä¸ªæ•°è¿˜æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œè€Œä¸æ˜¯åƒ this.setState ä¸€æ ·ï¼Œæ˜¯é åˆå¯¹è±¡å¹¶æ¥äº§ç”Ÿçš„æ–°å€¼ï¼Œæ¯”å¦‚`{...oldState, ...newState}`ï¼Œåœ¨è§†è§‰ä¸Šï¼Œthis.state å°±åƒæ˜¯ latestCount.current çš„ä¸€ä¸ªé•œåƒï¼Œä»–ä»¬ä»£è¡¨äº†åŒæ ·çš„æ¦‚å¿µã€‚ref æ˜¯ä¸€ç§â€œé€‰æ‹©é€€å‡ºâ€æ¸²æŸ“ä¸€è‡´æ€§çš„æ–¹æ³•ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ä¼šååˆ†æ–¹ä¾¿ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œåº”è¯¥é¿å…åœ¨æ¸²æŸ“æœŸé—´è¯»å–æˆ–è€…è®¾ç½® refsï¼Œå› ä¸ºå®ƒä»¬æ˜¯å¯å˜å¾—ï¼Œåº”è¯¥ä¿æŒæ¸²æŸ“çš„å¯é¢„æµ‹æ€§ã€‚

å‚è€ƒï¼š

- [A Complete Guide to useEffect](https://overreacted.io/a-complete-guide-to-useeffect/)
- [How to fetch data with React Hooks?](https://www.robinwieruch.de/react-hooks-fetch-data)
- [React hooks: get the current state, back to the future](https://dev.to/scastiel/react-hooks-get-the-current-state-back-to-the-future-3op2)
- [How Are Function Components Different from Classes?](https://overreacted.io/how-are-function-components-different-from-classes/)
